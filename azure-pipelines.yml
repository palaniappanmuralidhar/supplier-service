trigger:
  - main  # or master branch

pool:
  name: Default   # or the name of your self-hosted agent pool

variables:
  imageName: supplier-service
  tag: '$(Build.BuildId)' # unique tag per build
  acrName: 'myACRConnection'  # replace with your ACR name
  acrLoginServer: 'myacrconnection.azurecr.io'  # replace with your ACR login server

stages:

  # Stage 1: Build Spring Boot JAR
  - stage: Build
    displayName: 'Build Spring Boot Project'
    jobs:
      - job: Build
        steps:
          - task: Maven@3
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean package'
              options: '-DskipTests'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenVersionOption: 'Default'
              publishJUnitResults: false

  # Stage 2: Build Docker image and push to ACR using AzureRM
  - stage: Docker
    displayName: 'Build & Push Docker Image'
    dependsOn: Build
    jobs:
      - job: DockerBuild
        steps:
          # Login to ACR using AzureRM service connection
          - task: AzureCLI@2
            displayName: 'Login to ACR'
            inputs:
              azureSubscription: 'myACRConnection'  # your AzureRM service connection
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Logging in to ACR..."
                az acr login --name $(acrName)

          # Build and push Docker image
          - script: |
              docker build -t $(acrLoginServer)/$(imageName):$(tag) .
              docker push $(acrLoginServer)/$(imageName):$(tag)
            displayName: 'Build and Push Docker Image'

  # Stage 3: Deploy to Kubernetes
  - stage: Deploy
    displayName: 'Deploy to Kubernetes'
    dependsOn: Docker
    jobs:
      - deployment: DeployToK8s
        environment: 'Dev'  # optional
        strategy:
          runOnce:
            deploy:
              steps:
                - task: Kubernetes@1
                  displayName: 'kubectl apply deployment'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceConnection: 'k8s-connection'
                    namespace: 'default'
                    command: 'apply'
                    useConfigurationFile: true
                    configuration: 'deployment.yaml'

                - task: Kubernetes@1
                  displayName: 'kubectl apply service'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceConnection: 'k8s-connection'
                    namespace: 'default'
                    command: 'apply'
                    useConfigurationFile: true
                    configuration: 'service.yaml'
